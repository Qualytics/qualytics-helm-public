suite: test cluster issuer
templates:
  - issuer.yaml
tests:
  - it: should not render issuer when cert-manager is disabled
    set:
      certmanager.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render cluster issuer when cert-manager is enabled
    set:
      certmanager.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ClusterIssuer
        documentIndex: 0

  - it: should create cluster issuer with correct configuration
    set:
      certmanager.enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: "letsencrypt"
        documentIndex: 0
      - equal:
          path: spec.acme.server
          value: "https://acme-v02.api.letsencrypt.org/directory"
        documentIndex: 0

  - it: should configure HTTP01 solver
    set:
      certmanager.enabled: true
    asserts:
      - contains:
          path: spec.acme.solvers
          content:
            http01:
              ingress:
                class: nginx
        documentIndex: 0
