suite: test essential templates render correctly
templates:
  - secrets.yaml
  - ingress.yaml
  - postgres.yaml
  - rabbitmq.yaml
tests:
  # Secrets template tests
  - it: should render secrets with Auth0 configuration
    template: secrets.yaml
    set:
      global.authType: "AUTH0"
      secrets.auth0.auth0_audience: "test-api"
      secrets.auth0.auth0_organization: "org_test"
      secrets.auth0.auth0_spa_client_id: "spa_test"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: qualytics-creds
      - exists:
          path: data.auth0_audience
      - exists:
          path: data.auth0_organization
      - exists:
          path: data.auth0_spa_client_id

  - it: should render secrets with OIDC configuration
    template: secrets.yaml
    set:
      global.authType: "OIDC"
      secrets.oidc.oidc_scopes: "openid profile email"
      secrets.oidc.oidc_client_id: "test-client"
    asserts:
      - isKind:
          of: Secret
      - exists:
          path: data.oidc_scopes
      - exists:
          path: data.oidc_client_id

  # Ingress template tests
  - it: should render ingress when enabled
    template: ingress.yaml
    set:
      ingress.enabled: true
      global.dnsRecord: "test.qualytics.io"
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: Ingress
        documentIndex: 0

  # PostgreSQL template tests
  - it: should render postgres resources when enabled
    template: postgres.yaml
    set:
      postgres.enabled: true
    asserts:
      - hasDocuments:
          count: 6
      - isKind:
          of: StatefulSet
        documentIndex: 2

  # RabbitMQ template tests
  - it: should render rabbitmq resources
    template: rabbitmq.yaml
    asserts:
      - hasDocuments:
          count: 5
      - isKind:
          of: StatefulSet
        documentIndex: 3